<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPS Map Camera</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  overflow:hidden
}
video,canvas{
  position:fixed;
  top:0;left:0;
  width:100vw;height:100vh;
  object-fit:cover
}
#overlay{
  position:fixed;
  bottom:16px;left:16px;
  background:rgba(0,0,0,.75);
  padding:12px 14px;
  border-radius:10px;
  font-size:14px;
  line-height:1.4
}
#controls{
  position:fixed;
  bottom:24px;right:16px;
  display:flex;
  gap:10px
}
button{
  padding:13px 16px;
  font-size:15px;
  border-radius:10px;
  border:none;
  background:#1976d2;
  color:#fff
}
button.secondary{background:#444}
button:disabled{background:#555}
.good{color:#00e676}
.bad{color:#ff5252}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none"></canvas>

<div id="overlay">
  <div id="location">ğŸ“ Getting locationâ€¦</div>
  <div id="coords">ğŸŒ --</div>
  <div id="extra">ğŸ§­ -- | ğŸš— -- | â›°ï¸ --</div>
  <div id="accuracy" class="bad">Accuracy: --</div>
  <div id="time">â° --</div>
</div>

<div id="controls">
  <button id="switchBtn" class="secondary">ğŸ” Camera</button>
  <button id="captureBtn" disabled>ğŸ“¸ Capture</button>
</div>

<script>
/* ---------- ELEMENTS ---------- */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const locationEl=document.getElementById("location");
const coordsEl=document.getElementById("coords");
const extraEl=document.getElementById("extra");
const accuracyEl=document.getElementById("accuracy");
const timeEl=document.getElementById("time");
const captureBtn=document.getElementById("captureBtn");
const switchBtn=document.getElementById("switchBtn");

/* ---------- STATE ---------- */
let stream=null;
let watchId=null;
let facing="environment";
let lat=null, lon=null, alt="N/A", speed="0";
let accuracy=999;
let heading="--";
let locked=false;
let lockCount=0;
let locationText="Unknown location";

/* ---------- TIME ---------- */
setInterval(()=>{
  timeEl.innerText="â° "+new Date().toLocaleString();
},1000);

/* ---------- CAMERA ---------- */
async function startCamera(){
  stopCamera();
  stream=await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:facing }
  });
  video.srcObject=stream;
}
function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
}
switchBtn.onclick=async()=>{
  facing=facing==="environment"?"user":"environment";
  await startCamera();
};

/* ---------- COMPASS ---------- */
window.addEventListener("deviceorientation",e=>{
  if(e.alpha!==null){
    const d=Math.round(e.alpha);
    const dirs=["N","NE","E","SE","S","SW","W","NW"];
    heading=dirs[Math.round(d/45)%8]+" ("+d+"Â°)";
  }
});

/* ---------- GPS ---------- */
function startGPS(){
  stopGPS();

  /* FAST COARSE FIX */
  navigator.geolocation.getCurrentPosition(pos=>{
    lat=pos.coords.latitude;
    lon=pos.coords.longitude;
    coordsEl.innerText=`ğŸŒ ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    locationEl.innerText="ğŸ“ Getting accurate GPSâ€¦";
  });

  /* ACCURATE WATCH */
  watchId=navigator.geolocation.watchPosition(async pos=>{
    accuracy=pos.coords.accuracy;
    accuracyEl.innerText="Accuracy: Â±"+Math.round(accuracy)+" m";

    if(accuracy>20){
      accuracyEl.className="bad";
      return;
    }

    accuracyEl.className="good";
    lat=pos.coords.latitude;
    lon=pos.coords.longitude;
    alt=pos.coords.altitude?pos.coords.altitude.toFixed(1)+" m":"N/A";
    speed=pos.coords.speed?(pos.coords.speed*3.6).toFixed(1)+" km/h":"0 km/h";

    lockCount++;
    if(lockCount>=2 && !locked){
      locked=true;
      captureBtn.disabled=false;

      coordsEl.innerText=`ğŸŒ ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      extraEl.innerText=`ğŸ§­ ${heading} | ğŸš— ${speed} | â›°ï¸ ${alt}`;

      try{
        const r=await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
        );
        const d=await r.json();
        locationText=d.display_name||locationText;
        locationEl.innerText="ğŸ“ "+locationText;
      }catch{
        locationEl.innerText="ğŸ“ Location unavailable";
      }
    }
  },()=>locationEl.innerText="ğŸ“ Location denied",
  {enableHighAccuracy:true,maximumAge:0});
}
function stopGPS(){
  if(watchId!==null){
    navigator.geolocation.clearWatch(watchId);
    watchId=null;
  }
}

/* ---------- CAPTURE ---------- */
captureBtn.onclick=()=>{
  if(!locked) return;

  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  ctx.fillStyle="rgba(0,0,0,0.7)";
  ctx.fillRect(0,canvas.height-170,canvas.width,170);
  ctx.fillStyle="#fff";
  ctx.font="22px Arial";

  let y=canvas.height-135;
  ctx.fillText("ğŸ“ "+locationText,20,y);
  ctx.fillText(`ğŸŒ ${lat.toFixed(6)}, ${lon.toFixed(6)}`,20,y+=30);
  ctx.fillText(`ğŸ§­ ${heading} | ğŸš— ${speed}`,20,y+=30);
  ctx.fillText(`â›°ï¸ ${alt}`,20,y+=30);
  ctx.fillText("â° "+new Date().toLocaleString(),20,y+=30);

  canvas.style.display="block";
  video.style.display="none";

  setTimeout(()=>{
    if(confirm("Save photo?")){
      const dataUrl=canvas.toDataURL("image/jpeg",0.95);

      /* WEB FALLBACK */
      const a=document.createElement("a");
      a.href=dataUrl;
      a.download="GPS_Photo_"+Date.now()+".jpg";
      a.click();

      /* APK: yahin se native Filesystem / MediaStore plugin call hoga */
    }
    retake();
  },300);
};
function retake(){
  canvas.style.display="none";
  video.style.display="block";
}

/* ---------- FREEZE FIX ---------- */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){
    stopCamera();
    stopGPS();
  }else{
    startCamera();
    startGPS();
  }
});

/* ---------- START ---------- */
startCamera();
startGPS();
</script>

</body>
</html>
