<!DOCTYPE html>
<html lang="hi">
<head>

    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>GPS Map Camera - Ultra Pro Max (Official Final Build)</title>
    <meta name="description" content="GPS Map Camera app to capture photos with real-time GPS location, address, latitude longitude and map watermark. Camera with location stamp for survey and inspection.">

<meta name="keywords" content="gps map camera, camera with gps location, gps photo camera, location camera app, geo tag camera, camera with location stamp, gps coordinates camera, map camera gps">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* CSS ROOT VARIABLES */
        :root {
            --primary-color: #00e676; /* WhatsApp & Success Green */
            --secondary-color: #1e88e5; /* Professional Field Blue */
            --danger-color: #ff5252; /* Error/Alert Red */
            --dark-bg: #000000;
            --overlay-bg: rgba(0, 0, 0, 0.82);
            --text-color: #ffffff;
            --glass-border: rgba(255, 255, 255, 0.18);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --shadow-heavy: 0 15px 55px rgba(0, 0, 0, 0.85);
        }

        /* -----------------------------------------------------------------
           CORE SYSTEM RESET & PERFORMANCE OPTIMIZATION
           ----------------------------------------------------------------- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-color);
            font-family: var(--font-main);
            overflow: hidden;
            user-select: none;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* -----------------------------------------------------------------
           VISUAL HARDWARE LAYERS (VIDEO & PROCESSING CANVAS)
           ----------------------------------------------------------------- */
        #video-preview, #capture-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: black;   
    z-index: 1;
}
/* Smooth Camera Switch Animation */
.camera-switching {
    opacity: 0;
    transform: scale(0.95);
    filter: blur(15px); /* Camera badalte waqt blur effect */
    transition: all 0.4s ease-in-out;
}

#video-preview {
    transition: transform 0.5s ease, opacity 0.4s ease; /* Smooth Transform */
}


        #capture-canvas {
            display: none; /* Internal processing only */
        }

        /* Front camera mirroring logic */
        .mirrored {
            transform: scaleX(-1);
        }

        /* -----------------------------------------------------------------
           GEOTAG HUD OVERLAY (REAL-TIME DATA DASHBOARD)
           ----------------------------------------------------------------- */
     #data-overlay {
    position: absolute;
    bottom: 25px;         /* Niche se sahi balance */
    left: 15px;
    width: 260px;         /* Width ko restrict kiya */
    max-height: 150px;    /* Height ko restrict kiya */
    background: rgba(0, 0, 0, 0.4); /* Professional transparent black */
    backdrop-filter: blur(10px);    /* Premium glass look */
    border: 1px solid rgba(255, 255, 255, 0.15); /* Patli professional border */
    border-radius: 10px;
    padding: 10px;
    color: #fff;
    font-size: 10.5px;    /* Chota aur saaf font */
    overflow: hidden;     /* Text box se bahar nahi jayega */
    z-index: 15;
    pointer-events: none; /* Screen touch mein disturb nahi karega */
}

/* Address line ke liye special fix */
#data-overlay .address-line {
    white-space: normal;  /* Lamba address line change karega */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Sirf 2 lines dikhayega agar bahut bada address ho */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}
        .data-row {
    font-size: 11px; /* Font chota kiya */
    display: flex;
    align-items: flex-start;
    gap: 8px;
}


        .data-label {
    font-weight: bold;
    width: 20px;         /* 32px se ghatakar 20px kiya */
    text-align: center;
    font-size: 12px;     /* Icons ka size 18px se 12px kiya */
    opacity: 0.9;
}


        .data-value {
            color: #f2f2f2;
            flex: 1;
            line-height: 1.6;
            letter-spacing: 0.3px;
        }

        /* Accuracy Color Coding Logic */
        .status-good {
            color: var(--primary-color);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
        }

        .status-bad {
            color: var(--danger-color);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(255, 82, 82, 0.3);
        }

        /* -----------------------------------------------------------------
           FLOATING INTERFACE CONTROLS
           ----------------------------------------------------------------- */
        .btn-circle {
            position: fixed;
            width: 68px;
            height: 68px;
            border-radius: 50%;
            border: none;
            background: var(--secondary-color);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.65);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-circle:active {
            transform: scale(0.82);
            filter: brightness(1.2);
        }

        
#capture-btn {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    z-index: 25;
    
    /* Premium Metallic Gradient */
    background: linear-gradient(145deg, #ffffff, #b0bec5); 
    
    /* Ring Border */
    border: 5px solid rgba(255, 255, 255, 0.3); 
    
    /* 3D Depth Effect (Shadows) */
    box-shadow: 
        0 10px 25px rgba(0,0,0,0.5),      /* Button ke neeche shadow */
        inset 0 2px 4px rgba(255,255,255,0.9), /* Upar chamak (Highlight) */
        inset 0 -3px 6px rgba(0,0,0,0.2);      /* Neeche depth */
        
    cursor: pointer;
}

/* Click karne par thoda dabne ka effect */
#capture-btn:active {
    transform: translateX(-50%) scale(0.95);
    background: linear-gradient(145deg, #b0bec5, #ffffff);
}


        /* Precise positioning for tooltips */
        /* --- Professional Layout: Buttons in Corners --- */
#switch-camera {
    position: fixed;

    right: 18px;          /* √∞≈∏‚ÄòÀÜ SAME vertical line */
    bottom: 250px;

    width: 52px;
    height: 52px;
    border-radius: 50%;

    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    border: 1.5px solid rgba(255,255,255,0.2);

    display: flex;
    align-items: center;
    justify-content: center;

    z-index: 9999;
}

#toggle-flash {
    position: fixed;

    right: 18px;          /* √∞≈∏‚ÄòÀÜ SAME AS SETTINGS */
    bottom: 180px;        /* √∞≈∏‚ÄòÀÜ vertical spacing */

    width: 52px;
    height: 52px;
    border-radius: 50%;

    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    border: 1.5px solid rgba(255,255,255,0.2);

    display: flex;
    align-items: center;
    justify-content: center;

    z-index: 9999;
}

/* Flash ON Active State */
.flash-active {
    background: rgba(255, 215, 0, 0.3) !important;
    border: 2px solid #FFD700 !important;
    box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), inset 0 0 10px #FFD700 !important;
    transform: scale(1.1) !important;
    color: #FFD700 !important;
}

#open-settings {
    position: fixed;

    right: 18px;          /* √∞≈∏‚ÄòÀÜ reference vertical line */
    bottom: 110px;

    width: 52px;
    height: 52px;
    border-radius: 50%;

    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    border: 1.5px solid rgba(255,255,255,0.2);

    display: flex;
    align-items: center;
    justify-content: center;

    z-index: 9999;
}

        /* -----------------------------------------------------------------
           AAPKA UPDATED HERO BUTTON
           ----------------------------------------------------------------- */
        .hero-btn {
            padding: 22px 80px;
            border-radius: 50px;
            border: none;
            background: var(--primary-color);
            font-weight: 900;
            font-size: 22px;
            color: #000;
            box-shadow: 0 15px 45px rgba(0, 230, 118, 0.45);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .hero-btn:active { transform: scale(0.92); }
                /* --- User Policy Box Design --- */
        .policy-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            max-height: 180px;
            overflow-y: auto;
            text-align: left;
            font-size: 12px;
            line-height: 1.5;
            color: #ccc;
        }
        .policy-check {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            color: #fff;
            font-size: 14px;
        }
        .policy-check input {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }

        /* -----------------------------------------------------------------
           SETTINGS DRAWER (SLIDE-UP)
           ----------------------------------------------------------------- */
        /* Line 265 ke paas is block ko update karein */
#settings-panel {
    position: fixed;
    bottom: -100%;
    left: 0;
    width: 100%;
    background: #161616;
    border-radius: 38px 38px 0 0;
    padding: 40px 30px 80px 30px; /* Niche 80px padding add ki hai */
    z-index: 10000 !important;   /* Isse panel hamesha sabse upar rahega */
    transition: bottom 0.5s cubic-bezier(0.2, 1, 0.3, 1);
    border-top: 5px solid var(--primary-color);
}


        #settings-panel.active {
            bottom: 0;
        }

        .setting-header {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .toggle-label { font-size: 16px; font-weight: 500; }

        input[type=range] {
            width: 140px;
            accent-color: var(--primary-color);
        }

        /* -----------------------------------------------------------------
           ANIMATED MODAL (SAVE CONFIRMATION)
           ----------------------------------------------------------------- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-out;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: #1c1c1c;
            border: 1px solid var(--glass-border);
            padding: 45px 35px;
            border-radius: 45px;
            text-align: center;
            width: 92%;
            max-width: 400px;
            box-shadow: 0 45px 90px rgba(0,0,0,0.95);
            transform: scale(0.65) translateY(70px);
            opacity: 0;
            transition: all 0.55s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal-box {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-title {
            color: var(--primary-color);
            font-size: 26px;
            margin: 15px 0 10px 0;
        }

        .modal-body {
            color: #b0b0b0;
            line-height: 1.6;
            margin-bottom: 35px;
            font-size: 16px;
        }

        .modal-footer {
            display: flex;
            gap: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 22px;
            font-weight: 900;
            font-size: 17px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn:active { transform: scale(0.94); }

        .btn-save { background: var(--primary-color); color: #000; box-shadow: 0 8px 25px rgba(0, 230, 118, 0.25); }
        .btn-discard { background: #333; color: #fff; }

        /* -----------------------------------------------------------------
           DYNAMIC ACTION BAR (OPEN & SHARE)
           ----------------------------------------------------------------- */
        #action-bar {
            position: fixed;
            bottom: -150px;
            left: 20px;
            right: 20px;
            background: #141414;
            border-radius: 30px;
            padding: 20px;
            z-index: 4000;
            display: flex;
            gap: 18px;
            transition: bottom 0.75s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1.5px solid var(--primary-color);
            box-shadow: 0 25px 60px rgba(0, 230, 118, 0.35);
        }

        #action-bar.show {
            bottom: 35px;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px;
            border: none;
            border-radius: 22px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-open { background: #2a2a2a; color: white; }
        .btn-whatsapp { background: #25D366; color: white; }

        /* -----------------------------------------------------------------
           ONBOARDING / PERMISSION SCREEN
           ----------------------------------------------------------------- */
        #perm-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 45px;
        }

        .hero-title {
            color: var(--primary-color);
            font-size: 40px;
            margin: 0 0 20px 0;
            text-shadow: 0 0 20px rgba(0, 230, 118, 0.4);
        }

        .hero-desc {
            color: #777;
            font-size: 18px;
            margin-bottom: 50px;
            max-width: 300px;
            line-height: 1.6;
        }
       /* =========================================
    ULTIMATE HUD STYLES
   ========================================= */
#intro-splash {
    position: fixed; inset: 0;
    background: #000;
    z-index: 99999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: 'Segoe UI', monospace; /* Monospace for Tech feel */
    overflow: hidden;
}

/* Cyber Grid Background */
.grid-bg {
    position: absolute; width: 200%; height: 200%;
    background-image: 
        linear-gradient(rgba(0, 255, 136, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 136, 0.05) 1px, transparent 1px);
    background-size: 50px 50px;
    transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
    animation: grid-move 10s linear infinite;
    opacity: 0.6;
}
@keyframes grid-move { 0% {transform: perspective(500px) rotateX(60deg) translateY(0);} 100% {transform: perspective(500px) rotateX(60deg) translateY(50px);} }

/* HUD RADAR SYSTEM */
.hud-container {
    position: relative; width: 140px; height: 140px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 30px;
}
.app-icon { font-size: 50px; z-index: 10; animation: icon-pulse 2s infinite; }

/* Rings Animation */
.hud-ring {
    position: absolute; border-radius: 50%;
    border: 1px solid rgba(0, 230, 118, 0.3);
    box-shadow: 0 0 10px rgba(0, 230, 118, 0.1);
}
.outer { width: 100%; height: 100%; border-top-color: #00e676; border-bottom-color: #00e676; animation: spin-cw 4s linear infinite; }
.middle { width: 75%; height: 75%; border-left-color: #00e676; border-right-color: #00e676; animation: spin-ccw 3s linear infinite; }
.inner { width: 50%; height: 50%; border: 2px dashed rgba(0, 230, 118, 0.6); animation: spin-cw 5s linear infinite; }
.hud-scan-line {
    position: absolute; width: 100%; height: 2px; background: #00e676;
    box-shadow: 0 0 10px #00e676;
    animation: radar-scan 2s linear infinite;
    opacity: 0.7;
}

@keyframes spin-cw { 100% { transform: rotate(360deg); } }
@keyframes spin-ccw { 100% { transform: rotate(-360deg); } }
@keyframes radar-scan { 0% {top:0%; opacity:0;} 50% {opacity:1;} 100% {top:100%; opacity:0;} }

/* Typography */
.splash-title {
    color: #fff; font-size: 28px; font-weight: 800; letter-spacing: 2px;
    margin-bottom: 30px; z-index: 2;
    text-shadow: 0 0 20px rgba(0, 230, 118, 0.4);
}
.pro-badge {
    background: #00e676; color: #000; padding: 2px 6px; border-radius: 4px;
    font-size: 14px; vertical-align: middle;
}

/* SYSTEM CHECK LIST */
.system-check-list {
    width: 280px; margin-bottom: 30px; z-index: 2;
}
.check-item {
    display: flex; align-items: center; gap: 15px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    color: #888; font-size: 13px;
    transition: all 0.3s;
}
.check-item.active { color: #fff; text-shadow: 0 0 5px #00e676; }
.status-icon { width: 15px; text-align: center; }

/* Progress */
.progress-container {
    width: 240px; display: flex; align-items: center; gap: 10px; z-index: 2;
}
.progress-bar {
    flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; position: relative;
    overflow: hidden;
}
.progress-bar::after {
    content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 0%;
    background: #00e676;
    animation: progress-fill 3.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    box-shadow: 0 0 10px #00e676;
}
#progress-percent { color: #00e676; font-size: 12px; font-weight: bold; width: 35px; }

.loading-status {
    margin-top: 15px; font-size: 10px; color: #555; letter-spacing: 3px; z-index: 2;
}

@keyframes progress-fill { 0%{width:0%} 100%{width:100%} }
 
    </style>
</head>

<body>
<div id="intro-splash">
    <div class="grid-bg"></div>
    
    <div class="hud-container">
        <div class="hud-ring outer"></div>
        <div class="hud-ring middle"></div>
        <div class="hud-ring inner"></div>
        <div class="hud-scan-line"></div>
        <div class="app-icon material-icons">gps_fixed</div>
    </div>
    
    <h1 class="splash-title">GPS CAMERA <span class="pro-badge">PRO</span></h1>
    
    <div class="system-check-list">
        <div class="check-item" id="item-gps">
            <span class="status-icon material-icons">check_circle</span>
            <span class="status-text">Calibrating GPS Sensors...</span>
        </div>
        <div class="check-item" id="item-map">
            <span class="status-icon material-icons">check_circle</span>
            <span class="status-text">Loading Map Overlay...</span>
        </div>
        <div class="check-item" id="item-cam">
            <span class="status-icon material-icons">check_circle</span>
            <span class="status-text">Initializing 4K Lens...</span>
        </div>
        <div class="check-item" id="item-secure">
            <span class="status-icon material-icons">check_circle</span>
            <span class="status-text">Verifying Secure Storage...</span>
        </div>
    </div>

    <div class="progress-container">
        <div class="progress-bar"></div>
        <span id="progress-percent">0%</span>
    </div>
    
    <p class="loading-status">SYSTEM BOOT SEQUENCE INITIATED</p>
</div>

    <video id="video-preview" autoplay playsinline></video>
    <canvas id="capture-canvas" style="display:none"></canvas>

    <div id="data-overlay">
     

    <!-- STATUS -->
    <div class="data-row">
        <span class="data-label material-icons">location_on</span>
        <span id="txt-status" class="data-value">Initializing Sensors...</span>
    </div>

    <!-- COORDINATES -->
    <div class="data-row">
        <span class="data-label material-icons">public</span>
        <span id="txt-coords" class="data-value">0.000000, 0.000000</span>
    </div>

    <!-- ADDRESS -->
    <div class="data-row">
        <span class="data-label material-icons">home</span>
        <span id="txt-address" class="data-value">Searching Location...</span>
    </div>

    <!-- SENSORS -->
    <div class="data-row">
        <span class="data-label material-icons">explore</span>
        <span id="txt-sensors" class="data-value">0√Ø¬ø¬Ω | 0 km/h | 0.0m</span>
    </div>

    <!-- ACCURACY -->
    <div class="data-row">
        <span class="data-label material-icons">straighten</span>
        <span id="txt-accuracy" class="data-value status-bad">Accuracy Calibration...</span>
    </div>

    <!-- TIME -->
    <div class="data-row">
        <span class="data-label material-icons">schedule</span>
        <span id="txt-time" class="data-value">--/--/----, --:-- am/pm</span>
    </div>

</div>
    </div>
    <button id="switch-camera" class="btn-circle material-icons" title="Switch Lens">
cameraswitch
</button>
<button id="toggle-flash" class="btn-circle material-icons" title="Toggle Light">
flash_on
</button>
<button id="open-settings" class="btn-circle material-icons" title="Settings">
settings
</button>
    <button id="capture-btn" title="Capture Geotagged Image"></button>

    <div id="action-bar">
    <button id="btn-share-whatsapp" class="action-btn btn-whatsapp material-icons">
share
</button>
<button id="btn-close-bar" class="material-icons">
close
</button>
</div>


    <div id="save-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <img id="photo-preview"
     style="
        width: 100%;
        max-height: 320px;
        object-fit: contain;
        background: #000;
        border-radius: 20px;
        margin-bottom: 22px;
        display: none;
     " />
                       <h2 class="modal-title" style="letter-spacing: 0.5px;">Field Report Generated</h2>
            <p class="modal-body" style="font-size: 15px; color: #ccc;">
                Geotagged documentation captured successfully. <br>
                Verify location data and confirm to save.
            </p>
            <div class="modal-footer">
                <button id="btn-discard" class="modal-btn btn-discard">Discard</button>
                <button id="btn-save" class="modal-btn btn-save">Confirm & Save</button>
                
            </div>                 
        </div>                            
   </div>
            
           <div id="success-modal" class="modal-overlay" style="z-index: 20002;">
    <div class="modal-box" style="background: #1c1c1c; border: 1px solid var(--primary-color); text-align: center; max-width: 300px;">
        
        <div style="margin-bottom: 15px;">
            <span class="material-icons" style="font-size: 55px; color: var(--primary-color); text-shadow: 0 0 15px rgba(0,230,118,0.4);">
                check_circle
            </span>
        </div>

        <h2 style="color: #fff; font-size: 20px; margin-bottom: 8px;">Saved Successfully</h2>
        <p style="color: #aaa; font-size: 13px; margin-bottom: 25px;">
            Photo Gallery mein save ho gayi hai.
        </p>

        <div class="modal-footer" style="flex-direction: column; gap: 10px;">
            
            <button onclick="shareOnWhatsApp()" class="modal-btn" style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;">
                <span class="material-icons">whatsapp</span> Share on WhatsApp
            </button>

            <button onclick="closeSuccessModal()" class="modal-btn" style="background: #333; color: #fff; width: 100%;">
                Close / Band Karein
            </button>

        </div>
    </div>
</div>
 


   <div id="settings-panel">
        <h2 class="setting-header">Pro Configurations</h2>
        <div class="setting-item">
            <span class="toggle-label">Accuracy Limit: <b id="lbl-acc-limit">50m</b></span>
            <input id="rng-accuracy" type="range" min="10" max="250" step="5" value="50">
        </div>
        <div class="setting-item">
            <span class="toggle-label">Distance Throttle: <b id="lbl-dist-limit">30m</b></span>
            <input id="rng-distance" type="range" min="10" max="150" step="10" value="30">
        </div>
        <div class="setting-item">
            <span class="toggle-label">Enable Watermark Stamp</span>
            <input id="chk-stamp" type="checkbox" style="width:25px; height:25px;" checked>
        </div>
        <div class="setting-item">
            <span class="toggle-label">High-Res Mode (1080p)</span>
            <input id="chk-hd" type="checkbox" style="width:25px; height:25px;" checked>
        </div>

        <button id="close-settings" style="width:100%; padding:18px; background:#333; color:white; border:none; border-radius:20px; font-weight:bold; margin-top:20px; cursor:pointer;">Theek Hai</button>
        </div>   
        
    <div id="perm-screen">
    <h1 class="hero-title">GPS Map Camera</h1>
    <p class="hero-desc" id="perm-status">Professional Field Survey Tool</p>
    
    
    <div id="perm-content">
        <div class="policy-box">
            <b style="color:var(--primary-color);">Permissions Required:</b><br><br>
            1. <b>Camera:</b> Documentation capture ke liye.<br>
            2. <b>GPS:</b> Real-time location stamping ke liye.<br>
            3. <b>Storage:</b> Photos ko gallery mein save karne ke liye.
        </div>
        <button class="hero-btn" onclick="handleStart()">Accept & Initialize</button>
    </div>

    <div id="denied-content" style="display:none;">
        <p style="color:var(--danger-color); margin-bottom:20px;">Permissions Denied! <br> App bina sensors ke kaam nahi karegi.</p>
        <button class="hero-btn" onclick="location.reload()" style="background:var(--danger-color);">Try Again / Grant Access</button>
    </div>
</div>


    <script>
    let LAST_SAVED_PHOTO_URI = "";
    // √¢≈ì‚Ä¶ ULTIMATE SPLASH SCREEN LOGIC
    function safeText(str) {
    if (!str) return "";
    return str
        .replace(//g, "OK")
        .replace(//g, "OFFLINE")
        .replace(//g, "")
        .replace(//g, "")
        .replace(/[^\x00-\x7F]/g, "");
}
function closeSuccessModal() {
  const modal = document.getElementById("success-modal");
  if (modal) {
    modal.classList.remove("active");
  }
}
// ‚úÖ WHATSAPP SHARE FUNCTION WITH PLAY STORE LINK
async function shareOnWhatsApp() {
  // Check agar photo save hui hai ya nahi
  if (!LAST_SAVED_PHOTO_URI) {
    // Fallback: Agar kisi wajah se URI nahi mili, toh user ko alert karein
    alert("Please save the photo first!");
    return;
  }

  // Aapki App ID
  const playStoreLink = "https://play.google.com/store/apps/details?id=com.ravi.gpscamera";
  
  // Message jo photo ke sath jayega
  const message = "üìç Captured via GPS Map Camera Pro.\nDownload App: " + playStoreLink;

  try {
      if (window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.Share) {
        await Capacitor.Plugins.Share.share({
          title: "Share Field Report",
          text: message,           // Message + Link
          url: LAST_SAVED_PHOTO_URI, // Photo ka path
          dialogTitle: "Share via WhatsApp"
        });
      } else {
        console.log("Sharing not supported in browser.");
        alert("Sharing works on Mobile App only.");
      }
  } catch (error) {
      console.error("Share Error:", error);
  }
}



/* -----------------------------------------------------------------
   GLOBAL APPLICATION STATE & SMART THROTTLING
----------------------------------------------------------------- */
        let stream, track, facing = "environment", watchId;
        let settingsClickCount = 0;
let isInterstitialReady = false;
async function initializeAdMob() {
    if (!window.Capacitor) return;
    try {
        const { AdMob } = Capacitor.Plugins;
        AdMob.addListener('interstitialAdLoaded', () => { isInterstitialReady = true; });
                AdMob.addListener('interstitialAdDismissed', () => {
             isInterstitialReady = false;
             setTimeout(() => {
                 preloadNextInterstitial(); 
             }, 5000);
        });

        AdMob.addListener('interstitialAdFailedToLoad', () => { isInterstitialReady = false; });

        await AdMob.initialize({
            initializeForTesting: false
        });

        preloadNextInterstitial(); 
    } catch (e) { console.error("AdMob Init Error", e); }
}

async function preloadNextInterstitial() {
    if (!window.Capacitor || !Capacitor.Plugins || !Capacitor.Plugins.AdMob) return;

    try {
        const { AdMob } = Capacitor.Plugins;

        await AdMob.loadInterstitial({
            adId: 'ca-app-pub-7807602925578307/8272818556',
            isTesting: false
        });

        isInterstitialReady = true;
    } catch (e) {
        console.error("Interstitial load failed", e);
        isInterstitialReady = false;
    }
}

async function showBlockingInterstitialAd() {
    if (!window.Capacitor || !isInterstitialReady) return;
    try {
        await Capacitor.Plugins.AdMob.showInterstitial();
    } catch (e) {
        console.warn("Ad failed, continuing...", e);
    }
}


let isBannerLoaded = false;

async function triggerBannerAd() {
    if (!window.Capacitor) return;
    try {
        const { AdMob } = Capacitor.Plugins;

        if (isBannerLoaded) {
            await AdMob.removeBanner();
            isBannerLoaded = false;
        }

        await AdMob.showBanner({
            adId: 'ca-app-pub-7807602925578307/5483003680',
            position: 'TOP_CENTER',
            margin: 35,
            size: 'BANNER',
            isTesting: false
        });

        isBannerLoaded = true;
    } catch (e) {
        console.error("Banner Fail", e);
        setTimeout(triggerBannerAd, 5000);
    }
}

if (window.Capacitor) {
    window.Capacitor.Plugins.App.addListener('appStateChange', ({ isActive }) => {
        if (isActive) triggerBannerAd();
    });
}

        let lat = 0, lon = 0, alt = "0m", speed = "0 km/h", accuracy = 999, lastAccuracy = 999, heading = "0√Ç¬∞", address = "Searching Location...";

   
        /* ===================== GOOGLE MAPS API √¢‚Ç¨‚Äú HARDENED SECURITY ===================== */

const __k1 = "QUl6YVN5Ql9YbHBQcHFKUmxT";
const __k2 = "ZHZxbTRDSzd0OWhEQmJxN0oxcXB3";

function __getKey() {
    const joined = (__k1 + __k2).split("").reverse().join("");
    return atob(joined.split("").reverse().join(""));
}

const GOOGLE_MAPS_API_KEY = (() => {
    try {
        return __getKey();
    } catch {
        return "";
    }
})();

/* ===================== END SECURITY BLOCK ===================== */
        // Smart API Throttling Variables
        let lastLat = 0, lastLon = 0, lastApiTime = 0;

        // APPLICATION CONFIGURATION
        const appConfig = {
            applicationId: "com.ravi.gpscamera", 
            get playStoreUrl() { return `https://play.google.com/store/apps/details?id=${this.applicationId}`; }
        };

        const shutterAudio = new Audio("data:audio/mp3;base64,//uQxAAADhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFh");

        // DOM ELEMENTS CACHE
        const video = document.getElementById("video-preview");
        const canvas = document.getElementById("capture-canvas");
        const ctx = canvas.getContext("2d");
        const actionBar = document.getElementById("action-bar");
        const saveModal = document.getElementById("save-modal-overlay");
        const accSlider = document.getElementById("rng-accuracy");
        const accLabel = document.getElementById("lbl-acc-limit");
        const distSlider = document.getElementById("rng-distance");
        const distLabel = document.getElementById("lbl-dist-limit");
        
        /**
 * POLICY & START LOGIC: Button click par turant app shuru karein
 */


/**
 * CORE INITIALIZATION: Permissions aur Camera start karein
 */
 // √¢≈ì‚Ä¶ FIX-4: User Consent (UMP / GDPR Safe)
async function requestUserConsent() {
    if (!window.Capacitor || !Capacitor.Plugins || !Capacitor.Plugins.AdMob) {
        return;
    }

    try {
        const { AdMob } = Capacitor.Plugins;

        const consentInfo = await AdMob.requestConsentInfo();

        if (consentInfo.isConsentFormAvailable && consentInfo.status === 'REQUIRED') {
            await AdMob.showConsentForm();
        }
    } catch (e) {
        console.warn("Consent error:", e);
    }
}
/* =================================================================
   FIX #3: STARTUP RACE CONDITION PREVENTER
   Global variable add karein
   ================================================================= */
let isSystemInitialized = false; // <-- YE GLOBAL FLAG ZAROORI HAI

/**
 * POLICY BUTTON ACTION (UPDATED)
 * Ab ye safe tarike se system boot karega.
 */
let isCameraBusy = false; 

/**
 * HARDWARE: CAMERA MANAGEMENT ENGINE (FIXED & SAFE)
 * Updates:
 * 1. Removed 'exact' keyword (Prevents crashes on Oppo/Vivo/Samsung).
 * 2. Added 100ms hardware flush delay.
 * 3. Improved Retry Logic.
 */
async function startCamera() {
    // 1. SAFETY: Agar camera busy hai, to request ignore karo
    if (isCameraBusy) {
        console.warn("Camera is busy, skipping request.");
        return false;
    }

    isCameraBusy = true; // üîí LOCK ON

    try {
        const videoEl = document.getElementById("video-preview");
        
        // 2. CLEANUP: Purana stream dhang se band karo
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
            
            // üõë SAFETY DELAY: Hardware ko flush hone ke liye 100ms do
            // Ye line 'Black Screen' aur 'App Freeze' hone se bachati hai
            await new Promise(r => setTimeout(r, 100)); 
        }
        
        const isHD = document.getElementById("chk-hd").checked;
        
        // 3. CONSTRAINTS (CRITICAL FIX)
        const constraints = {
            video: {
                // ‚ùå PURANA: facingMode: { exact: facing }  <-- YE CRASH KARATA THA
                // ‚úÖ NAYA: facingMode: facing             <-- YE SAFE HAI
                facingMode: facing, 
                
                aspectRatio: 4 / 3,
                width: { ideal: isHD ? 1600 : 1280 },
                height: { ideal: isHD ? 1200 : 960 },
                frameRate: { ideal: 30 }
            },
            audio: false
        };

        // 4. HARDWARE REQUEST
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        videoEl.srcObject = stream;
        track = stream.getVideoTracks()[0];
        
        // Mirror Logic (Sirf Selfie ke liye)
        // classList.toggle kabhi kabhi buggy hota hai, isliye manual if/else behtar hai
        if (facing === "user") {
            videoEl.classList.add("mirrored");
        } else {
            videoEl.classList.remove("mirrored");
        }

        // 5. PLAY
        videoEl.onloadedmetadata = () => {
            videoEl.play().catch(e => console.log("Force play error", e));
        };
        videoEl.style.display = "block";

        isCameraBusy = false; // üîì LOCK OFF (Success)
        return true; 

    } catch (e) {
        console.warn("Camera Start Failed:", e);
        
        // 6. SMART RETRY LOGIC
        // Pehle lock kholo
        isCameraBusy = false; 

        // Agar permission deny hui hai, toh retry mat karo (Infinite Loop Bachao)
        if (e.name === "NotAllowedError" || e.name === "PermissionDeniedError") {
            alert("Permission Denied: Please allow Camera access in Settings.");
            return false;
        }

        // Agar HD quality ki wajah se fail hua, toh Low Quality try karo
        if (document.getElementById("chk-hd").checked) {
            console.log("High-Res failed, switching to Standard Quality...");
            document.getElementById("chk-hd").checked = false;
            return await startCamera(); // üîÑ Retry
        } else {
            // Agar sab fail ho gaya
            alert("Camera Error: " + e.message);
            return false; 
        }
    }
}




/**
 * CONSOLIDATED INITIALIZATION FLOW (SAFE BOOT)
 * Ensures system boots exactly ONCE.
 */
async function initializeSystem() {
    // -------------------------------------------------------------
    // üîí SAFETY CHECK: Agar system pehle se on hai, to yahi ruk jao
    // -------------------------------------------------------------
    if (isSystemInitialized) {
        console.log("‚ö†Ô∏è System already initialized. Skipping duplicate boot.");
        return; 
    }
    
    isSystemInitialized = true; // Flag set kar diya (Ab koi dusra isse nahi chala payega)
    console.log("‚úÖ System Booting...");

    // 1. HARDWARE START (Strictly Serialized)
    try {
        console.log("Requesting Camera...");
        
        // Fix 1 wala camera logic use hoga yahan
        const cameraStarted = await startCamera(); 
        
        if (!cameraStarted) {
            console.error("Aborting boot: Camera failed to initialize.");
            document.getElementById("txt-status").innerText = "Camera Failed";
            // Note: Hum flag false nahi karenge, taaki loop na bane. Restart required.
            return; 
        }
        
        console.log("Camera ready. Requesting GPS...");
        
        // UI settle hone ka wait
        await new Promise(r => setTimeout(r, 500)); 
        
        startGPS();

    } catch (e) {
        console.error("Hardware Init Fail:", e);
        alert("System failed to start. Please restart.");
    }

    // 2. BUTTON LISTENERS (Ab safe jagah par initialize honge)
    try {
        const btnSettings = document.getElementById("open-settings");
        if(btnSettings) {
             btnSettings.onclick = (e) => {
                e.stopPropagation();
                document.getElementById("settings-panel").classList.add("active");
            };
        }

        // Switch Camera Button (Ab Fix 1 wale logic ke sath safe hai)
        const btnSwitch = document.getElementById("switch-camera");
        // (Note: Iska click handler humne Fix 1 me alag se define kiya tha, 
        // toh yahan dobara likhne ki zaroorat nahi hai agar wo global scope me hai.
        // Agar nahi, to ensure karein ki Fix 1 wala code script me maujood ho)

        const btnFlash = document.getElementById("toggle-flash");
        // Flash logic bhi global scope me rakhna behtar hai, ya yahan define karein.
        
    } catch (e) {
        console.warn("Button Setup Error:", e);
    }

    // 3. ADS & CONSENT (Background Service)
    if (window.Capacitor) {
        setTimeout(async () => {
            try {
                if (window.Capacitor.Plugins.AdMob) {
                    await requestUserConsent();
                    await initializeAdMob();
                    triggerBannerAd();
                }
            } catch (e) {
                console.warn("Ad Service Error:", e);
            }
        }, 8000); 
    }
    
    console.log("üöÄ System Live.");
    


    // 2. BUTTON LOGIC (Keep buttons working)
    try {
        const btnSettings = document.getElementById("open-settings");
        if(btnSettings) {
             btnSettings.onclick = (e) => {
                e.stopPropagation();
                document.getElementById("settings-panel").classList.add("active");
            };
        }

        const btnSwitch = document.getElementById("switch-camera");
        if(btnSwitch) {
            btnSwitch.onclick = () => {
                facing = (facing === "environment") ? "user" : "environment";
                startCamera();
            };
        }

        const btnFlash = document.getElementById("toggle-flash");
        if(btnFlash) {
             btnFlash.onclick = async () => {
                if (!track) return;
                try {
                    const caps = track.getCapabilities();
                    if (caps.torch) {
                        const settings = track.getSettings();
                        const isOn = settings.torch || false;
                        await track.applyConstraints({ advanced: [{ torch: !isOn }] });
                        btnFlash.classList.toggle("flash-active", !isOn);
                    }
                } catch (e) { console.error("Torch error", e); }
            };
        }
    } catch (e) {
        console.warn("Button Setup Error:", e);
    }

    // 3. ADS & CONSENT (Background)
    if (window.Capacitor) {
        setTimeout(async () => {
            try {
                if (window.Capacitor.Plugins.AdMob) {
                    await requestUserConsent();
                    await initializeAdMob();
                    triggerBannerAd();
                }
            } catch (e) {
                console.warn("Ad Service Error:", e);
            }
        }, 8000); // Increased delay to 8s to ensure permissions are done
    }
    
    console.log("System Live.");
}
       

/* =================================================================
   UPDATED SWITCH CAMERA BUTTON LISTENER
   ================================================================= */
document.getElementById("switch-camera").onclick = async () => {
    // 1. SAFETY CHECK: Agar camera busy hai, to click ignore karo
    if (isCameraBusy) return; 

    const videoEl = document.getElementById("video-preview");
    const btn = document.getElementById("switch-camera");

    // Visual Effect Start
    videoEl.classList.add("camera-switching");
    btn.style.transition = "transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55)";
    btn.style.transform = "rotate(180deg)";

    setTimeout(async () => {
        try {
            // Mode Palto
            facing = facing === "user" ? "environment" : "user";

            // Camera Start Karo (Await zaroori hai)
            await startCamera();

            // Mirror Class Toggle
            if (facing === "user") {
                videoEl.classList.add("mirrored");
            } else {
                videoEl.classList.remove("mirrored");
            }

        } catch (e) {
            console.error("Switch Error:", e);
        } finally {
            // Effect Hatao
            videoEl.classList.remove("camera-switching");
            
            // Button Reset
            setTimeout(() => {
                btn.style.transition = "none";
                btn.style.transform = "rotate(0deg)";
            }, 500);
        }
    }, 300);
};

        /**
         * HARDWARE: SMART GPS ENGINE (API THROTTLING)
         * Uses Haversine formula to reduce API hits for 10k users.
         */
        function startGPS() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            
            watchId = navigator.geolocation.watchPosition(async (pos) => {
                accuracy = pos.coords.accuracy;
                lat = pos.coords.latitude; 
                lon = pos.coords.longitude;
                alt = pos.coords.altitude ? pos.coords.altitude.toFixed(1) + "m" : "0.0m";
                speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) + " km/h" : "0 km/h";
               // GPS course fallback (when compass sensor fails)
if (pos.coords.heading !== null && !isNaN(pos.coords.heading)) {
    heading = Math.round(pos.coords.heading) + "¬∞";
}
// HARD LOCATION LOCK (ADD HERE)
if (accuracy <= 15 && speed <= 1) {
    if (!window.__locationLocked) {
        window.__locationLocked = true;
        fetchReverseGeocode(lat, lon);
        document.getElementById("txt-status").innerText = "Location Locked";
    }
}
                // Real-time HUD updates (Visual only)
                document.getElementById("txt-coords").innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById("txt-sensors").innerText = `${heading} | ${speed} | ${alt}`;
                
                const accEl = document.getElementById("txt-accuracy");
                accEl.innerText = `Accuracy: ${Math.round(accuracy)} m`;
                
                // SMART THROTTLE CHECK
                const now = Date.now();
const distMoved = calculateHaversine(lat, lon, lastLat, lastLon);
const minDistance = parseInt(distSlider.value);
const minTimeMs = 60000;
const accuracyImproved = (accuracy < lastAccuracy - 5);

if (distMoved > minDistance || (now - lastApiTime) > minTimeMs || accuracyImproved) {
    const limit = parseInt(accSlider.value);
    if (accuracy <= limit) {
        accEl.className = "data-value status-good";
        fetchReverseGeocode(lat, lon);
        lastLat = lat; 
        lastLon = lon; 
        lastApiTime = now; 
        lastAccuracy = accuracy;
    } else {
        accEl.className = "data-value status-bad";
    }
}

            }, (err) => {
                document.getElementById("txt-status").innerText = "GPS Signal Weak";
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
        }

        /**
         * MATH ENGINE: HAVERSINE FORMULA
         * Calculates displacement in meters to preserve API limits.
         */
        function calculateHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }
// REAL INTERNET CHECK (FIELD + APK SAFE)
async function isOnline() {
    // 1√Ø¬∏¬è√¢∆í¬£ Quick browser hint
    if (!navigator.onLine) return false;

    // 2√Ø¬∏¬è√¢∆í¬£ Soft network validation (NOT too strict)
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 2000);

        const res = await fetch("https://www.google.com/favicon.ico", {
            method: "GET",
            signal: controller.signal,
            cache: "no-store"
        });

        clearTimeout(timeout);
        return res && res.ok;
    } catch (e) {
        // Fallback: browser says online, so allow API try
        return true;
    }
}

       async function fetchReverseGeocode(lt, ln) {

    // OFFLINE MODE
    if (!(await isOnline())) {
        address = `Offline Mode\nLat ${lt.toFixed(6)}, Lon ${ln.toFixed(6)}`;
        document.getElementById("txt-address").innerText = address;
        document.getElementById("txt-status").innerText = "Offline Mode";
        return;
    }

    // ONLINE MODE
    try {
        const res = await fetch(
            `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lt},${ln}&key=${GOOGLE_MAPS_API_KEY}`
        );
        const data = await res.json();

        if (data.status === "OK" && data.results.length > 0) {

            let bestResult = data.results.find(r =>
                r.types.includes("street_address") ||
                r.types.includes("route") ||
                r.types.includes("sublocality") ||
                r.types.includes("locality")
            ) || data.results[0];

            address = bestResult.formatted_address;

            document.getElementById("txt-address").innerText =
                address.length > 70 ? address.substring(0, 67) + "..." : address;

            document.getElementById("txt-status").innerText =
"Location Verified";

        } else {
            document.getElementById("txt-address").innerText =
                `Lat ${lt.toFixed(6)}, Lon ${ln.toFixed(6)}`;
            document.getElementById("txt-status").innerText = "Address Unavailable";
        }

    } catch {
        document.getElementById("txt-address").innerText =
            `Lat ${lt.toFixed(6)}, Lon ${ln.toFixed(6)}`;
        document.getElementById("txt-status").innerText =
"Network Error";
    }
} 

        /* -----------------------------------------------------------------
   HARDWARE: COMPASS SENSOR
   SMART COMPASS (Android + APK SAFE)
----------------------------------------------------------------- */


        /**
         * PHOTOGRAPHY: CAPTURE & WATERMARK STAMPING
         */
         // TORCH / FLASH LOGIC (With Visual Feedback)
document.getElementById("toggle-flash").onclick = async () => {
    if (!stream) return; // Camera check
    const track = stream.getVideoTracks()[0];
    const btn = document.getElementById("toggle-flash");

    try {
        const capabilities = track.getCapabilities();
        if (!capabilities.torch) {
            alert("Flash unavailable on this lens.");
            return;
        }

        const settings = track.getSettings();
        const isFlashNowOn = !settings.torch; 

        await track.applyConstraints({
            advanced: [{ torch: isFlashNowOn }]
        });

        // UI Toggle
        if (isFlashNowOn) {
            btn.classList.add("flash-active");
        } else {
            btn.classList.remove("flash-active");
        }
    } catch (e) {
        console.error("Flash Error:", e);
        btn.classList.remove("flash-active"); // Reset on error
    }
};
// PRO CAMERA SWITCH LOGIC (Smooth + Mirror Fix)
document.getElementById("switch-camera").onclick = async () => {
    const videoEl = document.getElementById("video-preview");
    const btn = document.getElementById("switch-camera");

    // 1. Visual Effect Start (Blur & Fade Out)
    videoEl.classList.add("camera-switching");

    // Button Rotate Animation
    btn.style.transition = "transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55)";
    btn.style.transform = "rotate(180deg)";

    // 2. Thoda wait karein taaki effect dikhe (300ms)
    setTimeout(async () => {
        try {
            // 3. Mode Palto (Front <-> Back)
            facing = facing === "user" ? "environment" : "user";

            // 4. Camera Start Karo
            await startCamera();

            // 5. Mirror Class Toggle (Selfie ke liye)
            // Agar "user" (Selfie) hai, toh CSS class .mirrored lagayega
            if (facing === "user") {
                videoEl.classList.add("mirrored");
            } else {
                videoEl.classList.remove("mirrored");
            }

        } catch (e) {
            console.error("Switch Error:", e);
        } finally {
            // 6. Effect Hatao (Fade In Wapas)
            videoEl.classList.remove("camera-switching");
            
            // Button Reset
            setTimeout(() => {
                btn.style.transition = "none";
                btn.style.transform = "rotate(0deg)";
            }, 500);
        }
    }, 300);
};

 /* =================================================================
   FIX #4 COMPLETE: CAPTURE BUTTON + MISSING WATERMARK FUNCTION
   Paste this entire block to fix "renderProWatermark not defined".
   ================================================================= */

document.getElementById("capture-btn").onclick = () => {
    // 1. Audio & Camera Check
    shutterAudio.play().catch(()=>{});
    if (video.videoWidth === 0 || video.videoHeight === 0) return;

    // 2. Setup Canvas
    const videoW = video.videoWidth;
    const videoH = video.videoHeight;
    canvas.width = videoW;
    canvas.height = videoH;

    // 3. Draw Camera Frame (Mirror if Selfie)
    if (facing === "user") { 
        ctx.translate(canvas.width, 0); 
        ctx.scale(-1, 1); 
    }
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset

    // 4. WATERMARK LOGIC
    if (document.getElementById("chk-stamp").checked) {
        
        // --- Calculation Variables ---
        const padding = Math.round(canvas.width * 0.04);
        const cardW = canvas.width * 0.92;
        const cardX = (canvas.width - cardW) / 2;
        const mapSize = Math.round(canvas.width * 0.22); 
        const cardH = mapSize + (padding * 2);
        const cardY = canvas.height - cardH - padding;
        const mapX = cardX + padding;
        const mapY = cardY + padding;

        // Semi-Transparent Card Background
        ctx.fillStyle = "rgba(0, 0, 0, 0.65)";
        ctx.fillRect(cardX, cardY, cardW, cardH);

        // --- MAP HANDLING (Anti-Ghosting Fix) ---
        let isMapHandled = false; 

        const mapImg = new Image();
        mapImg.crossOrigin = "anonymous";
        mapImg.src = `https://maps.googleapis.com/maps/api/staticmap?center=${lat.toFixed(6)},${lon.toFixed(6)}&zoom=16&size=300x300&scale=2&maptype=roadmap&markers=color:red|${lat.toFixed(6)},${lon.toFixed(6)}&key=${GOOGLE_MAPS_API_KEY}`;
        
        // A. TIMEOUT (5 Sec)
        const mapTimeout = setTimeout(() => {
            if (!isMapHandled) {
                mapImg.onerror(); // Trigger fallback
            }
        }, 5000);

        // B. SUCCESS
        mapImg.onload = () => {
            if (isMapHandled) return;
            isMapHandled = true;
            clearTimeout(mapTimeout);

            try {
                ctx.drawImage(mapImg, mapX, mapY, mapSize, mapSize);
            } catch (e) {
                console.warn("Map draw error", e);
            }
            // Finish
            finishCapture(cardX, cardW, cardY, mapX, mapSize, mapY);
        }; 

        // C. ERROR / OFFLINE FALLBACK
        mapImg.onerror = () => {
            if (isMapHandled) return;
            isMapHandled = true;
            clearTimeout(mapTimeout);

            // Dark Box
            ctx.fillStyle = "#1a1a1a";
            ctx.fillRect(mapX, mapY, mapSize, mapSize);

            // Grid Lines
            ctx.strokeStyle = "rgba(0, 230, 118, 0.2)";
            ctx.lineWidth = 1;
            for (let i = 1; i < 5; i++) {
                let step = mapSize / 5;
                ctx.beginPath();
                ctx.moveTo(mapX + (step * i), mapY);
                ctx.lineTo(mapX + (step * i), mapY + mapSize);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(mapX, mapY + (step * i));
                ctx.lineTo(mapX + mapSize, mapY + (step * i));
                ctx.stroke();
            }

            // Radar Circle & Pin
            ctx.strokeStyle = "rgba(0, 230, 118, 0.6)";
            ctx.beginPath();
            ctx.arc(mapX + mapSize / 2, mapY + mapSize / 2, mapSize / 3, 0, 2 * Math.PI);
            ctx.stroke();

            ctx.fillStyle = "#ff5252";
            ctx.beginPath();
            ctx.arc(mapX + mapSize / 2, mapY + mapSize / 2, 6, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.font = "bold 10px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("OFFLINE", mapX + mapSize / 2, mapY + mapSize - 10);

            // Finish
            finishCapture(cardX, cardW, cardY, mapX, mapSize, mapY);
        }; 

    } else {
        // Watermark OFF -> Direct Save
        const previewImg = document.getElementById("photo-preview");
        if (previewImg) {
            previewImg.src = canvas.toDataURL("image/jpeg", 0.85);
            previewImg.style.display = "block";
        }
        saveModal.classList.add("active");
        actionBar.classList.remove("show");
    }
};

/* --- HELPER 1: Finish Capture Step --- */
function finishCapture(cardX, cardW, cardY, mapX, mapSize, mapY) {
    // ‚ö†Ô∏è IMPORTANT: Ye function niche define kiya gaya hai
    renderProWatermark(ctx, cardX, cardW, cardY, mapX, mapSize, mapY);
    
    const previewImg = document.getElementById("photo-preview");
    if (previewImg) {
        previewImg.src = canvas.toDataURL("image/jpeg", 0.85);
        previewImg.style.display = "block";
    }

    saveModal.classList.add("active");
    actionBar.classList.remove("show");
}

/* --- HELPER 2: THE MISSING FUNCTION (Isse Error Hat Jayega) --- */
function renderProWatermark(ctx, cardX, cardW, cardY, mapX, mapSize, mapY) {
    const baseFS = Math.round(canvas.width * 0.032);
    const padding = 12 * (canvas.width / 1080);
    
    ctx.textAlign = "right";
    ctx.font = `bold ${Math.round(baseFS * 0.6)}px sans-serif`;
    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
    ctx.fillText("GPS Map Camera Pro", cardX + cardW - padding, cardY + (baseFS * 0.8));

    ctx.textAlign = "left";
    const textX = mapX + mapSize + (15 * (canvas.width / 1080));
    let currentY = mapY + (baseFS * 0.8);
    
    ctx.fillStyle = "#ffffff";
    ctx.font = `bold ${Math.round(baseFS * 1.0)}px sans-serif`;
    
    const addrParts = (address || "").split(',');
    const city = addrParts[0] || "Unknown";
    const stateCountry = addrParts.length >= 2 ? addrParts.slice(-2).join(', ').trim() : "GPS Location";
    const availableWidth = (cardX + cardW) - textX - padding;
    
    ctx.fillText(`${city} | ${stateCountry}`, textX, currentY, availableWidth);
   
    ctx.font = `${Math.round(baseFS * 0.7)}px sans-serif`;
    currentY += baseFS * 1.1;
    ctx.fillText((address || "Searching..."), textX, currentY, availableWidth);
    
    currentY += baseFS * 1.0;
    ctx.fillText(`Lat ${lat.toFixed(6)}¬∞ Long ${lon.toFixed(6)}¬∞`, textX, currentY);

    currentY += baseFS * 1.0;
    const now = new Date();
    const day = now.toLocaleDateString('en-IN', { weekday: 'long' }); 
    const dateStr = now.toLocaleDateString('en-GB');
    const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
    
    ctx.fillText(`${day}, ${dateStr} | ${timeStr}`, textX, currentY);
}

    
/* =================================================================
   FIX #2: MEMORY OPTIMIZATION & SAFE SAVING
   Updates:
   1. Quality reduced to 0.82 (Fixes OOM Crash)
   2. Garbage Collection hints (Variables = null)
   ================================================================= */

document.getElementById("btn-save").onclick = async () => {
    const saveBtn = document.getElementById("btn-save");
    
    // UI Lock: Button ko disable karein taaki user double tap na kare
    const originalText = saveBtn.innerText;
    saveBtn.innerText = "Saving...";
    saveBtn.disabled = true;

    try {
        // ---------------------------------------------------------
        // ‚ö†Ô∏è CRITICAL FIX: Quality 0.95 -> 0.82
        // JavaScript strings are UTF-16 (2 bytes per char). 
        // A 5MB image becomes 10MB in RAM. 0.82 reduces this risk significantly.
        // ---------------------------------------------------------
        let dataUrl = canvas.toDataURL("image/jpeg", 0.82); 
        let base64Data = dataUrl.replace(/^data:image\/jpeg;base64,/, "");
        
        // DataUrl variable ko turant khali karein taaki RAM free ho
        dataUrl = null; 

        const fileName = `GPS_PRO_${Date.now()}.jpg`;
        const ALBUM_NAME = "GPS_Map_Camera";

        if (window.Capacitor) {
            const { Filesystem, Media } = Capacitor.Plugins;

            // 1. Permissions Check
            // Note: Android 13+ mein Media permission alag tarah se mangi jati hai,
            // lekin Capacitor ka plugin ise handle kar leta hai.
            try {
                await Media.requestPermissions();
            } catch (permErr) {
                console.warn("Permission Warning:", permErr);
            }

            // 2. Save to CACHE first (Temporary Storage)
            // Hum sidhe gallery mein nahi likh sakte, pehle file system mein likhna padta hai
            const temp = await Filesystem.writeFile({
                path: fileName,
                data: base64Data,
                directory: "CACHE"
            });

            // Base64 string ka kaam khatam, ise bhi null karein (MEMORY SAVER)
            base64Data = null; 

            const fileUri = temp.uri.startsWith("file://")
                ? temp.uri
                : `file://${temp.uri}`;

            // 3. Create/Find Album
            let albumId;
            try {
                const album = await Media.createAlbum({
                    name: ALBUM_NAME
                });
                albumId = album.identifier;
            } catch (e) {
                // Album already exists -> fetch it
                try {
                    const albums = await Media.getAlbums();
                    const existing = albums.albums.find(a => a.name === ALBUM_NAME);
                    albumId = existing ? existing.identifier : null;
                } catch(err) {
                    console.warn("Album fetch error", err);
                }
            }

            // 4. FINAL SAVE TO GALLERY
            await Media.savePhoto({
                path: fileUri,
                albumIdentifier: albumId
            });
            
            // Global variable update karein (Share feature ke liye)
            LAST_SAVED_PHOTO_URI = fileUri;

            // ---------------------------------------------------------
            // ADMOB INTERSTITIAL LOGIC (Ads dikhana)
            // ---------------------------------------------------------
            if (window.Capacitor?.Plugins?.AdMob) {
                try {
                    await showBlockingInterstitialAd();
                } catch (e) {
                    console.warn("Interstitial not ready");
                }
            }

            // 5. Success UI Show karein
            document.getElementById("save-modal-overlay").classList.remove("active"); 
            
            setTimeout(() => {
                document.getElementById("success-modal").classList.add("active"); 
            }, 500);
  
        } else {
            // Browser Fallback (Testing ke liye)
            alert("Photo saved properly in Native App mode only.");
            document.getElementById("save-modal-overlay").classList.remove("active");
        }

    } catch (err) {
        alert("Save failed (Storage/Memory Error): " + err.message);
        console.error(err);
    } finally {
        // Hamesha button ko wapas normal karein, chahe error hi kyu na aaye
        saveBtn.innerText = originalText;
        saveBtn.disabled = false;
        
        // Memory cleanup ensuring
        base64Data = null; 
    }
};

        
        // 3. Action Bar
        document.getElementById("btn-close-bar").onclick = () => {
            document.getElementById("action-bar").classList.remove("show");
        };

        async function showManualAlert(Dialog) {
            if (Dialog) {
                await Dialog.alert({
                    title: 'Check Folder',
                    message: 'Gallery open nahi ho saki. Photo yahan hai: \nDCIM/GPS_Map_Camera',
                    buttonTitle: 'Close' 
                });
            } else { alert("Check folder: DCIM/GPS_Map_Camera"); }
        }
 

        /**
         * UI UTILS & APP LIFECYCLE
         */
         document.getElementById("chk-hd").onchange = () => {
    startCamera();
};
        document.getElementById("open-settings").onclick = () => document.getElementById("settings-panel").classList.add("active");
        document.getElementById("close-settings").onclick = () => document.getElementById("settings-panel").classList.remove("active");
        
        accSlider.oninput = () => { accLabel.innerText = accSlider.value + "m"; };
        distSlider.oninput = () => { distLabel.innerText = distSlider.value + "m"; };

        document.addEventListener("keydown", (e) => {
    if (e.keyCode === 24 || e.keyCode === 25 || e.code === "VolumeUp" || e.code === "VolumeDown") {
        e.preventDefault();
        const capBtn = document.getElementById("capture-btn");
        if (capBtn) capBtn.click();
    }
});


        document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    } else {
        if (localStorage.getItem("isReady") === "true") {
            startCamera();
            startGPS();
        }
    }
});


        setInterval(() => {
            document.getElementById("txt-time").innerText = new Date().toLocaleString('hi-IN');
        }, 1000);
//  ONE-TIME POLICY CHECK (App load hone par)
window.addEventListener("load", () => {
    // 1. Splash Screen Animation
    let pct = 0;
    const pctEl = document.getElementById('progress-percent');
    if(pctEl) {
        const interval = setInterval(() => {
            pct += Math.floor(Math.random() * 10) + 5;
            if(pct > 100) pct = 100;
            pctEl.innerText = pct + "%";
            if(pct === 100) clearInterval(interval);
        }, 150);
    }

    // 2. System Checks (Visuals)
    const items = ['item-gps', 'item-map', 'item-cam', 'item-secure'];
    items.forEach((id, i) => {
        setTimeout(() => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('active');
                el.querySelector('.status-icon').innerText = "check_circle";
                el.style.color = '#00e676';
            }
        }, 300 + (i * 300));
    });

    // 3. FINAL BOOT DECISION (Fixed Logic)
    setTimeout(() => {
        const splash = document.getElementById("intro-splash");
        const screen = document.getElementById("perm-screen");

        if (localStorage.getItem("isReady") === "true") {
            //  Agar permissions mil chuki hain -> Direct Start
            if (splash) splash.style.display = "none";
            if (screen) screen.style.display = "none";
            initializeSystem(); 
        } else {
            //  Agar first time hai -> Show Permission Screen
            if (splash) splash.style.display = "none";
            if (screen) screen.style.display = "flex";
        }
    }, 2500); 

    // Network Listeners (Internet Check)
    window.addEventListener("offline", () => {
        const el = document.getElementById("txt-status");
        if(el) el.innerText = "Internet Disconnected";
    });
    window.addEventListener("online", () => {
         const el = document.getElementById("txt-status");
        if(el) el.innerText = "Internet Connected";
    });
});

</script>
</body>
</html>
