<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPS Map Camera</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --accent:#00e676;
  --danger:#ff5252;
  --bg:#000;
  --card:rgba(0,0,0,.72);
}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:system-ui,-apple-system,Arial;
  overflow:hidden
}
video,canvas{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover
}

/* Overlay */
#overlay{
  position:fixed;
  bottom:16px;
  left:16px;
  right:16px;
  background:var(--card);
  border-radius:14px;
  padding:12px 14px;
  font-size:14px;
  line-height:1.45
}
.good{color:var(--accent)}
.bad{color:var(--danger)}

/* Buttons */
#captureBtn{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  padding:18px 28px;
  font-size:18px;
  border-radius:50px;
  border:none;
  background:var(--accent);
  color:#000;
  font-weight:600;
  animation:pulse 1.6s infinite
}
#switchBtn,#settingsBtn{
  position:fixed;
  right:16px;
  width:52px;
  height:52px;
  border-radius:50%;
  border:none;
  background:#1e88e5;
  color:#fff;
  font-size:20px
}
#switchBtn{bottom:45%}
#settingsBtn{bottom:32%}

@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(0,230,118,.6)}
  70%{box-shadow:0 0 0 22px rgba(0,230,118,0)}
  100%{box-shadow:0 0 0 0 rgba(0,230,118,0)}
}

/* Settings Sheet */
#settings{
  position:fixed;
  left:0;right:0;bottom:-100%;
  background:#111;
  border-radius:18px 18px 0 0;
  padding:20px;
  transition:.35s ease;
  z-index:10
}
#settings.show{bottom:0}
.setting{
  margin-bottom:16px
}
.setting label{
  display:flex;
  justify-content:space-between;
  align-items:center
}
input[type=range]{width:100%}
.toggle{
  appearance:none;
  width:46px;height:26px;
  background:#444;
  border-radius:13px;
  position:relative;
  outline:none
}
.toggle:checked{background:var(--accent)}
.toggle:before{
  content:'';
  position:absolute;
  width:22px;height:22px;
  background:#000;
  border-radius:50%;
  top:2px;left:2px;
  transition:.2s
}
.toggle:checked:before{left:22px}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none"></canvas>

<div id="overlay">
  <div id="loc">üìç Getting GPS‚Ä¶</div>
  <div id="coords">üåê --</div>
  <div id="extra">üß≠ -- | üöó -- | ‚õ∞Ô∏è --</div>
  <div id="acc" class="bad">Accuracy: --</div>
  <div id="time">‚è∞ --</div>
</div>

<button id="switchBtn">üîÅ</button>
<button id="settingsBtn">‚öôÔ∏è</button>
<button id="captureBtn">üì∏ Capture</button>

<!-- SETTINGS -->
<div id="settings">
  <h3>Settings</h3>

  <div class="setting">
    <label>
      Accuracy Threshold (meters)
      <span id="accVal"></span>
    </label>
    <input id="accRange" type="range" min="10" max="100" step="5">
  </div>

  <div class="setting">
    <label>
      Show Stamp
      <input id="stampToggle" type="checkbox" class="toggle">
    </label>
  </div>

  <div class="setting">
    <label>
      Auto Save to Gallery
      <input id="saveToggle" type="checkbox" class="toggle">
    </label>
  </div>

  <button onclick="toggleSettings()">Close</button>
</div>

<script>
/* STATE */
let stream,facing="environment",watchId;
let lat,lon,alt="N/A",speed="0",accuracy=999,heading="--",address="";
const settings={
  acc:localStorage.acc||50,
  stamp:localStorage.stamp!=="false",
  autosave:localStorage.autosave!=="false"
};

/* ELEMENTS */
const video=videoEl=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const accEl=document.getElementById("acc");
const locEl=document.getElementById("loc");
const coordsEl=document.getElementById("coords");
const extraEl=document.getElementById("extra");
const timeEl=document.getElementById("time");

/* SETTINGS UI */
accRange.value=settings.acc;
accVal.innerText=settings.acc+" m";
stampToggle.checked=settings.stamp;
saveToggle.checked=settings.autosave;

accRange.oninput=()=>{
  settings.acc=accRange.value;
  accVal.innerText=settings.acc+" m";
  localStorage.acc=settings.acc;
};
stampToggle.onchange=()=>localStorage.stamp=settings.stamp=stampToggle.checked;
saveToggle.onchange=()=>localStorage.autosave=settings.autosave=saveToggle.checked;

function toggleSettings(){
  document.getElementById("settings").classList.toggle("show");
}
settingsBtn.onclick=toggleSettings;

/* TIME */
setInterval(()=>timeEl.innerText="‚è∞ "+new Date().toLocaleString(),1000);

/* CAMERA */
async function startCamera(){
  stopCamera();
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
  video.srcObject=stream;
}
function stopCamera(){
  if(stream)stream.getTracks().forEach(t=>t.stop());
}
switchBtn.onclick=()=>{
  facing=facing==="environment"?"user":"environment";
  startCamera();
};

/* COMPASS */
window.addEventListener("deviceorientation",e=>{
  if(e.alpha!=null){
    const d=Math.round(e.alpha);
    const dirs=["N","NE","E","SE","S","SW","W","NW"];
    heading=dirs[Math.round(d/45)%8]+" "+d+"¬∞";
  }
});

/* GPS */
function startGPS(){
  stopGPS();
  watchId=navigator.geolocation.watchPosition(async p=>{
    accuracy=p.coords.accuracy;
    accEl.innerText="Accuracy: ¬±"+Math.round(accuracy)+" m";
    accEl.className=accuracy<=settings.acc?"good":"bad";

    lat=p.coords.latitude;
    lon=p.coords.longitude;
    alt=p.coords.altitude?p.coords.altitude.toFixed(1)+" m":"N/A";
    speed=p.coords.speed?(p.coords.speed*3.6).toFixed(1)+" km/h":"0 km/h";
    coordsEl.innerText=`üåê ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    extraEl.innerText=`üß≠ ${heading} | üöó ${speed} | ‚õ∞Ô∏è ${alt}`;

    if(!address){
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        address=(await r.json()).display_name||"";
        locEl.innerText="üìç "+address;
      }catch{}
    }
  },()=>locEl.innerText="üìç Location denied",{enableHighAccuracy:true});
}
function stopGPS(){if(watchId)navigator.geolocation.clearWatch(watchId);}

/* CAPTURE */
captureBtn.onclick=async()=>{
  if(accuracy>settings.acc){
    if(!confirm("GPS accuracy low (¬±"+Math.round(accuracy)+"m). Capture anyway?")) return;
  }
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(settings.stamp){
    ctx.fillStyle="rgba(0,0,0,.7)";
    ctx.fillRect(0,canvas.height-170,canvas.width,170);
    ctx.fillStyle="#fff";
    ctx.font="22px Arial";
    let y=canvas.height-135;
    ctx.fillText("üìç "+address,20,y);
    ctx.fillText(`üåê ${lat.toFixed(6)}, ${lon.toFixed(6)}`,20,y+=30);
    ctx.fillText(`üß≠ ${heading} | üöó ${speed}`,20,y+=30);
    ctx.fillText(`‚õ∞Ô∏è ${alt}`,20,y+=30);
    ctx.fillText("‚è∞ "+new Date().toLocaleString(),20,y+=30);
  }

  const data=canvas.toDataURL("image/jpeg",0.95);

  if(window.Capacitor && settings.autosave){
    const { Filesystem }=Capacitor.Plugins;
    await Filesystem.writeFile({
      path:"GPS_Photo_"+Date.now()+".jpg",
      data:data.split(",")[1],
      directory:"EXTERNAL",
      recursive:true
    });
  }else{
    const a=document.createElement("a");
    a.href=data;
    a.download="GPS_Photo_"+Date.now()+".jpg";
    a.click();
  }
};

/* LIFECYCLE */
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){stopCamera();stopGPS();}
  else{startCamera();startGPS();}
});

startCamera();
startGPS();
</script>

</body>
</html>
