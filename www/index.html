<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>GPS Map Camera - Ultra Pro Max (Official Final Build)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* CSS ROOT VARIABLES */
        :root {
            --primary-color: #00e676; /* WhatsApp & Success Green */
            --secondary-color: #1e88e5; /* Professional Field Blue */
            --danger-color: #ff5252; /* Error/Alert Red */
            --dark-bg: #000000;
            --overlay-bg: rgba(0, 0, 0, 0.82);
            --text-color: #ffffff;
            --glass-border: rgba(255, 255, 255, 0.18);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --shadow-heavy: 0 15px 55px rgba(0, 0, 0, 0.85);
        }

        /* -----------------------------------------------------------------
           CORE SYSTEM RESET & PERFORMANCE OPTIMIZATION
           ----------------------------------------------------------------- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-color);
            font-family: var(--font-main);
            overflow: hidden;
            user-select: none;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* -----------------------------------------------------------------
           VISUAL HARDWARE LAYERS (VIDEO & PROCESSING CANVAS)
           ----------------------------------------------------------------- */
        #video-preview, #capture-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #capture-canvas {
            display: none; /* Internal processing only */
        }

        /* Front camera mirroring logic */
        .mirrored {
            transform: scaleX(-1);
        }

        /* -----------------------------------------------------------------
           GEOTAG HUD OVERLAY (REAL-TIME DATA DASHBOARD)
           ----------------------------------------------------------------- */
        #data-overlay {
            position: fixed;
            bottom: 125px;
            left: 18px;
            right: 18px;
            background: var(--overlay-bg);
            border: 1px solid var(--glass-border);
            border-radius: 26px;
            padding: 22px;
            z-index: 10;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow-heavy);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .data-row {
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .data-label {
            font-weight: bold;
            width: 32px;
            text-align: center;
            font-size: 18px;
            opacity: 0.9;
        }

        .data-value {
            color: #f2f2f2;
            flex: 1;
            line-height: 1.6;
            letter-spacing: 0.3px;
        }

        /* Accuracy Color Coding Logic */
        .status-good {
            color: var(--primary-color);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.3);
        }

        .status-bad {
            color: var(--danger-color);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(255, 82, 82, 0.3);
        }

        /* -----------------------------------------------------------------
           FLOATING INTERFACE CONTROLS
           ----------------------------------------------------------------- */
        .btn-circle {
            position: fixed;
            width: 68px;
            height: 68px;
            border-radius: 50%;
            border: none;
            background: var(--secondary-color);
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.65);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-circle:active {
            transform: scale(0.82);
            filter: brightness(1.2);
        }

        #capture-btn {
            position: fixed;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            width: 105px;
            height: 105px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 10px solid rgba(255, 255, 255, 0.45);
            z-index: 25;
            animation: pulse-border 2.2s infinite;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); }
            70% { box-shadow: 0 0 0 35px rgba(0, 230, 118, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); }
        }

        /* Precise positioning for tooltips */
        #switch-camera { bottom: 530px; right: 22px; }
        #toggle-flash { bottom: 425px; right: 22px; }
        #open-settings { bottom: 320px; right: 22px; }

        /* -----------------------------------------------------------------
           AAPKA UPDATED HERO BUTTON
           ----------------------------------------------------------------- */
        .hero-btn {
            padding: 22px 80px;
            border-radius: 50px;
            border: none;
            background: var(--primary-color);
            font-weight: 900;
            font-size: 22px;
            color: #000;
            box-shadow: 0 15px 45px rgba(0, 230, 118, 0.45);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .hero-btn:active { transform: scale(0.92); }
        /* -----------------------------------------------------------------
           SETTINGS DRAWER (SLIDE-UP)
           ----------------------------------------------------------------- */
        #settings-panel {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: #161616;
            border-radius: 38px 38px 0 0;
            padding: 40px 30px;
            z-index: 100;
            transition: bottom 0.5s cubic-bezier(0.2, 1, 0.3, 1);
            border-top: 5px solid var(--primary-color);
            box-shadow: 0 -20px 60px rgba(0,0,0,0.8);
        }

        #settings-panel.active {
            bottom: 0;
        }

        .setting-header {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .toggle-label { font-size: 16px; font-weight: 500; }

        input[type=range] {
            width: 140px;
            accent-color: var(--primary-color);
        }

        /* -----------------------------------------------------------------
           ANIMATED MODAL (SAVE CONFIRMATION)
           ----------------------------------------------------------------- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-out;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            background: #1c1c1c;
            border: 1px solid var(--glass-border);
            padding: 45px 35px;
            border-radius: 45px;
            text-align: center;
            width: 92%;
            max-width: 400px;
            box-shadow: 0 45px 90px rgba(0,0,0,0.95);
            transform: scale(0.65) translateY(70px);
            opacity: 0;
            transition: all 0.55s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal-box {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-title {
            color: var(--primary-color);
            font-size: 26px;
            margin: 15px 0 10px 0;
        }

        .modal-body {
            color: #b0b0b0;
            line-height: 1.6;
            margin-bottom: 35px;
            font-size: 16px;
        }

        .modal-footer {
            display: flex;
            gap: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 22px;
            font-weight: 900;
            font-size: 17px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn:active { transform: scale(0.94); }

        .btn-save { background: var(--primary-color); color: #000; box-shadow: 0 8px 25px rgba(0, 230, 118, 0.25); }
        .btn-discard { background: #333; color: #fff; }

        /* -----------------------------------------------------------------
           DYNAMIC ACTION BAR (OPEN & SHARE)
           ----------------------------------------------------------------- */
        #action-bar {
            position: fixed;
            bottom: -150px;
            left: 20px;
            right: 20px;
            background: #141414;
            border-radius: 30px;
            padding: 20px;
            z-index: 4000;
            display: flex;
            gap: 18px;
            transition: bottom 0.75s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1.5px solid var(--primary-color);
            box-shadow: 0 25px 60px rgba(0, 230, 118, 0.35);
        }

        #action-bar.show {
            bottom: 35px;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px;
            border: none;
            border-radius: 22px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-open { background: #2a2a2a; color: white; }
        .btn-whatsapp { background: #25D366; color: white; }

        /* -----------------------------------------------------------------
           ONBOARDING / PERMISSION SCREEN
           ----------------------------------------------------------------- */
        #perm-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 45px;
        }

        .hero-title {
            color: var(--primary-color);
            font-size: 40px;
            margin: 0 0 20px 0;
            text-shadow: 0 0 20px rgba(0, 230, 118, 0.4);
        }

        .hero-desc {
            color: #777;
            font-size: 18px;
            margin-bottom: 50px;
            max-width: 300px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <video id="video-preview" autoplay playsinline></video>
    <canvas id="capture-canvas" style="display:none"></canvas>

    <div id="data-overlay">
        <div class="data-row">
            <span class="data-label">üìç</span>
            <span id="txt-status" class="data-value">Initializing Sensors...</span>
        </div>
        <div class="data-row">
            <span class="data-label">üåê</span>
            <span id="txt-coords" class="data-value">0.000000, 0.000000</span>
        </div>
        <div class="data-row">
            <span class="data-label">üè†</span>
            <span id="txt-address" class="data-value">Searching Location...</span>
        </div>
        <div class="data-row">
            <span class="data-label">üß≠</span>
            <span id="txt-sensors" class="data-value">0¬∞ | 0 km/h | 0.0m</span>
        </div>
        <div class="data-row">
            <span class="data-label">üìè</span>
            <span id="txt-accuracy" class="data-value status-bad">Accuracy Calibration...</span>
        </div>
        <div class="data-row">
            <span class="data-label">‚è∞</span>
            <span id="txt-time" class="data-value">--/--/----, --:--:-- am/pm</span>
        </div>
    </div>
    <button id="switch-camera" class="btn-circle" title="Switch Lens" style="bottom: 530px; right: 22px;">üîÅ</button>
    <button id="toggle-flash" class="btn-circle" title="Toggle Light" style="bottom: 425px; right: 22px;">üî¶</button>
    <button id="open-settings" class="btn-circle" title="Settings" style="bottom: 320px; right: 22px;">‚öôÔ∏è</button>
    
    <button id="capture-btn" title="Capture Geotagged Image"></button>

    <div id="action-bar">
        <button id="btn-open-photo" class="action-btn btn-open">üìÇ Photo Dekho</button>
        <button id="btn-share-whatsapp" class="action-btn btn-whatsapp">üí¨ WhatsApp</button>
    </div>

    <div id="save-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size: 80px; margin-bottom: 25px;">üì∏</div>
            <h2 class="modal-title">Photo Captured!</h2>
            <p class="modal-body">Bhai, professional geotagged report taiyaar hai. Kya ise phone ki Gallery mein save karein?</p>
            <div class="modal-footer">
                <button id="btn-discard" class="modal-btn btn-discard">Hata Do</button>
                <button id="btn-save" class="modal-btn btn-save">Save & Share</button>
            </div>
        </div>
    </div>

    <div id="settings-panel">
        <h2 class="setting-header">Pro Configurations</h2>
        
        <div class="setting-item">
            <span class="toggle-label">Accuracy Limit: <b id="lbl-acc-limit">50m</b></span>
            <input id="rng-accuracy" type="range" min="10" max="250" step="5" value="50">
        </div>

        <div class="setting-item">
            <span class="toggle-label">Distance Throttle: <b id="lbl-dist-limit">30m</b></span>
            <input id="rng-distance" type="range" min="10" max="150" step="10" value="30">
        </div>

        <div class="setting-item">
            <span class="toggle-label">Enable Watermark Stamp</span>
            <input id="chk-stamp" type="checkbox" style="width:25px; height:25px;" checked>
        </div>

        <div class="setting-item">
            <span class="toggle-label">High-Res Mode (1080p)</span>
            <input id="chk-hd" type="checkbox" style="width:25px; height:25px;" checked>
        </div>

        <button id="close-settings" style="width:100%; padding:18px; background:#333; color:white; border:none; border-radius:20px; font-weight:bold; margin-top:20px; cursor:pointer;">Theek Hai</button>
    </div>

    <div id="perm-screen">
        <h1 class="hero-title">GPS Map Camera</h1>
        <p class="hero-desc">Bhai, professional field surveys ke liye app ko Camera aur Location access ki zarurat hogi.</p>
        <button class="hero-btn" onclick="initializeSystem()">Shuru Karein</button>
    </div>

    <script>
        /**
         * GLOBAL APPLICATION STATE & SMART THROTTLING
         * -----------------------------------------------------------------
         */
        let stream, track, facing = "environment", watchId;
        let lat = 0, lon = 0, alt = "0m", speed = "0 km/h", accuracy = 999, heading = "0¬∞", address = "Searching Location...";
        let lastSavedUri = ""; 
        
        // Smart API Throttling Variables
        let lastLat = 0, lastLon = 0, lastApiTime = 0;

        // APPLICATION CONFIGURATION
        const appConfig = {
            applicationId: "com.ravi.gpscamera", 
            get playStoreUrl() { return `https://play.google.com/store/apps/details?id=${this.applicationId}`; }
        };

        const shutterAudio = new Audio("data:audio/mp3;base64,//uQxAAADhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFh");

        // DOM ELEMENTS CACHE
        const video = document.getElementById("video-preview");
        const canvas = document.getElementById("capture-canvas");
        const ctx = canvas.getContext("2d");
        const actionBar = document.getElementById("action-bar");
        const saveModal = document.getElementById("save-modal-overlay");
        const accSlider = document.getElementById("rng-accuracy");
        const accLabel = document.getElementById("lbl-acc-limit");
        const distSlider = document.getElementById("rng-distance");
        const distLabel = document.getElementById("lbl-dist-limit");

        /**
         * CORE INITIALIZATION SEQUENCE
         * Requests native permissions and boots hardware sensors.
         */
        async function initializeSystem() {
            if (window.Capacitor) {
                try {
                    // Requests mandatory storage permissions for Android DCIM access
                    const { Filesystem } = Capacitor.Plugins;
                    await Filesystem.requestPermissions();
                } catch (e) { console.warn("Native hardware permission bypass."); }
            }

            // Triggers Location Activation via browser API
            navigator.geolocation.getCurrentPosition(() => {}, () => {});

            localStorage.setItem('isReady', 'true');
            document.getElementById("perm-screen").style.display = "none";
            
            startCamera();
            startGPS();
        }
        /**
         * HARDWARE: CAMERA MANAGEMENT ENGINE
         * Handles lens switching and high-definition stream resolution.
         */
        async function startCamera() {
            try {
                // Prevents hardware lock by stopping existing tracks
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                }
                
                const isHD = document.getElementById("chk-hd").checked;
                const constraints = {
                    video: { 
                        facingMode: facing, 
                        width: { ideal: isHD ? 1920 : 1280 }, 
                        height: { ideal: isHD ? 1080 : 720 } 
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                
                // Front lens mirror handling
                video.classList.toggle("mirrored", facing === "user");
            } catch (e) { 
                alert("Camera fail ho gaya: " + e.message); 
            }
        }

        document.getElementById("switch-camera").onclick = () => {
            facing = (facing === "environment") ? "user" : "environment";
            startCamera();
        };

        document.getElementById("toggle-flash").onclick = async () => {
            if (!track) return;
            try {
                const caps = track.getCapabilities();
                if (!caps.torch) return alert("Flash is not supported on this lens.");
                
                const currentTorch = track.getSettings().torch || false;
                await track.applyConstraints({ advanced: [{ torch: !currentTorch }] });
            } catch (e) { console.error("Flash hardware error", e); }
        };

        /**
         * HARDWARE: SMART GPS ENGINE (API THROTTLING)
         * Uses Haversine formula to reduce API hits for 10k users.
         */
        function startGPS() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            
            watchId = navigator.geolocation.watchPosition(async (pos) => {
                accuracy = pos.coords.accuracy;
                lat = pos.coords.latitude; 
                lon = pos.coords.longitude;
                alt = pos.coords.altitude ? pos.coords.altitude.toFixed(1) + "m" : "0.0m";
                speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) + " km/h" : "0 km/h";

                // Real-time HUD updates (Visual only)
                document.getElementById("txt-coords").innerText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById("txt-sensors").innerText = `${heading} | ${speed} | ${alt}`;
                
                const accEl = document.getElementById("txt-accuracy");
                accEl.innerText = `Accuracy: ¬±${Math.round(accuracy)}m`;
                
                // SMART THROTTLE CHECK
                const now = Date.now();
                const distMoved = calculateHaversine(lat, lon, lastLat, lastLon);
                const minDistance = parseInt(distSlider.value);
                const minTimeMs = 60000; // 1 Minute cooldown

                if (distMoved > minDistance || (now - lastApiTime) > minTimeMs) {
                    const limit = parseInt(accSlider.value);
                    if (accuracy <= limit) {
                        accEl.className = "data-value status-good";
                        fetchReverseGeocode(lat, lon);
                        lastLat = lat; lastLon = lon; lastApiTime = now;
                    } else {
                        accEl.className = "data-value status-bad"; //
                    }
                }
            }, (err) => {
                document.getElementById("txt-status").innerText = "üìç GPS Signal Lost!";
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
        }

        /**
         * MATH ENGINE: HAVERSINE FORMULA
         * Calculates displacement in meters to preserve API limits.
         */
        function calculateHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }

        async function fetchReverseGeocode(lt, ln) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lt}&lon=${ln}`);
                const data = await res.json();
                address = data.display_name || "Location Verified";
                document.getElementById("txt-address").innerText = address.length > 70 ? address.substring(0, 67) + "..." : address;
                document.getElementById("txt-status").innerText = "üìç Geolocation Locked";
            } catch (e) {
                document.getElementById("txt-address").innerText = "Network Busy: Retrying...";
            }
        }

        /**
         * HARDWARE: COMPASS SENSOR
         */
        window.addEventListener("deviceorientationabsolute", (e) => {
            if (e.alpha !== null) heading = Math.round(e.alpha) + "¬∞";
        });

        /**
         * PHOTOGRAPHY: CAPTURE & WATERMARK STAMPING
         */
        document.getElementById("capture-btn").onclick = () => {
            shutterAudio.play().catch(()=>{});
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (facing === "user") { 
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1); 
            }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

           // WATERMARK PROCESS (Pro Version with Branding)
if (document.getElementById("chk-stamp").checked) {
    const padding = Math.round(canvas.width * 0.04);
    const cardW = canvas.width * 0.92;
    const cardH = Math.round(canvas.height * 0.25); 
    const cardX = (canvas.width - cardW) / 2;
    const cardY = canvas.height - cardH - padding;

    // Card Background
    ctx.fillStyle = "rgba(0, 0, 0, 0.65)";
    ctx.fillRect(cardX, cardY, cardW, cardH); 

    const mapSize = cardH * 0.75; 
    const mapX = cardX + (cardH * 0.12);
    const mapY = cardY + (cardH * 0.12);

    const mapImg = new Image();
    mapImg.crossOrigin = "anonymous";
    mapImg.src = `https://static-maps.yandex.ru/1.x/?ll=${lon},${lat}&z=15&l=map&size=300,300`;

    mapImg.onload = () => {
        ctx.drawImage(mapImg, mapX, mapY, mapSize, mapSize);
        renderProWatermark(ctx, cardX, cardW, cardY, mapX, mapSize, mapY);
        saveModal.classList.add("active");
        actionBar.classList.remove("show");
    };

    mapImg.onerror = () => {
        ctx.fillStyle = "#333"; 
        ctx.fillRect(mapX, mapY, mapSize, mapSize);
        renderProWatermark(ctx, cardX, cardW, cardY, mapX, mapSize, mapY);
        saveModal.classList.add("active");
    };
} else {
    saveModal.classList.add("active");
    actionBar.classList.remove("show");
}

// Function with Updated Pro Branding
function renderProWatermark(ctx, cardX, cardW, cardY, mapX, mapSize, mapY) {
    const fs = Math.round(canvas.width * 0.032);
    
    // Branding: Updated to GPS Map Camera Pro
    ctx.textAlign = "right";
    ctx.font = `bold ${fs * 0.6}px sans-serif`;
    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
    ctx.fillText("GPS Map Camera Pro", cardX + cardW - 12, cardY + 22);

    // Info Section
    ctx.textAlign = "left";
    const textX = mapX + mapSize + 15;
    let currentY = mapY + (fs * 1.0);
    
    ctx.fillStyle = "#ffffff";
    ctx.font = `bold ${fs * 1.1}px sans-serif`;
    const city = (address || "").split(',')[0];
    ctx.fillText(`${city || "Location"}, Maharashtra üáÆüá≥`, textX, currentY);

    ctx.font = `${fs * 0.75}px sans-serif`;
    currentY += fs * 1.3;
    ctx.fillText((address || "Searching...").substring(0, 42) + "...", textX, currentY);
    
    currentY += fs * 1.2;
    ctx.fillText(`Lat ${lat.toFixed(6)}¬∞ Long ${lon.toFixed(6)}¬∞`, textX, currentY);

    currentY += fs * 1.2;
    const now = new Date();
    const day = now.toLocaleDateString('en-IN', { weekday: 'long' });
    const dateStr = now.toLocaleDateString('en-GB');
    const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
    
    // Full line with Day, Date, and Time
    ctx.fillText(`${day}, ${dateStr} | ${timeStr}`, textX, currentY);
}
 

            saveModal.classList.add("active");
            actionBar.classList.remove("show");
        };

        document.getElementById("btn-discard").onclick = () => {
            saveModal.classList.remove("active");
        };

        /**
         * STORAGE: DCIM DIRECT SAVING
         */
        document.getElementById("btn-save").onclick = async () => {
            saveModal.classList.remove("active");
            const base64Data = canvas.toDataURL("image/jpeg", 0.95).split(",")[1];

            if (window.Capacitor && Capacitor.Plugins.Filesystem) {
                try {
                    const { Filesystem } = Capacitor.Plugins;
                    const fileName = `GPS_RECORD_PRO_${Date.now()}.jpg`;
                    const result = await Filesystem.writeFile({
                        path: `DCIM/GPS_Map_Camera/${fileName}`,
                        data: base64Data,
                        directory: 'EXTERNAL_STORAGE', 
                        recursive: true
                    });
                    
                    lastSavedUri = result.uri; 
                    actionBar.classList.add("show"); 
                    setTimeout(() => actionBar.classList.remove("show"), 25000);
                } catch (e) { alert("Save Error: " + e.message); }
            } else {
                const link = document.createElement("a");
                link.href = "data:image/jpeg;base64," + base64Data;
                link.download = `GPS_FIELD_REPORT.jpg`;
                link.click();
            }
        };

        /**
         * INTENTS: WHATSAPP & GALLERY FIX
         */
        document.getElementById("btn-share-whatsapp").onclick = async () => {
            if (!window.Capacitor || !lastSavedUri) return;
            const { Share } = Capacitor.Plugins;
            try {
                await Share.share({
                    title: 'Verified Geotag Report',
                    text: `Field documentation at: ${address}\nüìç Coordinates: ${lat}, ${lon}\n\nGet the Pro App at:\n${appConfig.playStoreUrl}`,
                    url: lastSavedUri,
                    dialogTitle: 'WhatsApp Team Share',
                });
            } catch (e) {}
        };

        /**
         * THE GALLERY FIX: Native File Opening
         */
        document.getElementById("btn-open-photo").onclick = async () => {
            if (window.Capacitor && Capacitor.Plugins.FileOpener) {
                try {
                    // Correct Capacitor community plugin syntax
                    await Capacitor.Plugins.FileOpener.open({
                        filePath: lastSavedUri,
                        contentType: 'image/jpeg'
                    });
                } catch (e) { alert("Gallery Viewer error. Manually check DCIM folder."); }
            } else {
                alert("Check folder: DCIM/GPS_Map_Camera");
            }
        };

        /**
         * UI UTILS & APP LIFECYCLE
         */
        document.getElementById("open-settings").onclick = () => document.getElementById("settings-panel").classList.add("active");
        document.getElementById("close-settings").onclick = () => document.getElementById("settings-panel").classList.remove("active");
        
        accSlider.oninput = () => { accLabel.innerText = accSlider.value + "m"; };
        distSlider.oninput = () => { distLabel.innerText = distSlider.value + "m"; };

        document.addEventListener("keydown", (e) => {
            if (e.key.includes("Volume")) { e.preventDefault(); document.getElementById("capture-btn").click(); }
        });

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                if (stream) stream.getTracks().forEach(t => t.stop());
                if (watchId) navigator.geolocation.clearWatch(watchId);
            } else if (localStorage.getItem('isReady')) { startCamera(); startGPS(); }
        });

        setInterval(() => {
            document.getElementById("txt-time").innerText = new Date().toLocaleString('hi-IN');
        }, 1000);

        if (localStorage.getItem('isReady')) initializeSystem();
    </script>
</body>
</html>
