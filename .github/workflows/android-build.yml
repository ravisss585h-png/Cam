name: Android Build (Crash Fix)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build

      # === CRASH FIX STEP ===
      - name: Smart Repair & Force Config
        run: |
          echo "üîç Checking for existing XML..."
          
          # 1. Backup XML
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            echo "‚úÖ XML Found! Backing up..."
            cp android/app/src/main/AndroidManifest.xml manifest_backup.xml
            HAS_MANIFEST="true"
          else
            echo "‚ö†Ô∏è No XML found, creating fresh."
            HAS_MANIFEST="false"
          fi

          # 2. Delete & Recreate Android Folder
          rm -rf android
          npx cap add android

          # 3. Restore & Fix XML
          if [ "$HAS_MANIFEST" = "true" ]; then
            echo "‚ôªÔ∏è Restoring your custom XML..."
            cp manifest_backup.xml android/app/src/main/AndroidManifest.xml
            
            # Fix 1: Remove 'package' attribute (Build Error Fix)
            sed -i 's/package="[^"]*"//' android/app/src/main/AndroidManifest.xml

            # Fix 2: FORCE REPLACE AdMob App ID (Crash Fix)
            # Pehle agar koi ID hai to us line ko delete karo
            sed -i '/com.google.android.gms.ads.APPLICATION_ID/d' android/app/src/main/AndroidManifest.xml
            
            # Ab sahi Test ID inject karo
            TEST_APP_ID="ca-app-pub-3940256099942544~3347511713"
            sed -i "s|</application>|<meta-data android:name=\"com.google.android.gms.ads.APPLICATION_ID\" android:value=\"$TEST_APP_ID\"/>\n    </application>|" android/app/src/main/AndroidManifest.xml
          fi

          # 4. Sync
          npx cap sync android

      - name: Generate App Icons
        run: |
          npm install @capacitor/assets --save-dev
          npx capacitor-assets generate --android

      - name: Build Debug APK
        working-directory: ./android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: gps-camera-crash-fix
          path: android/app/build/outputs/apk/debug/app-debug.apk
