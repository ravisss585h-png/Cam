name: Android Build (Smart XML Fix + AdMob)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      # 1. Code Checkout
      - name: Checkout Source
        uses: actions/checkout@v4

      # 2. Setup Java (Android ke liye)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Install Dependencies
      - name: Install Dependencies
        run: npm install

      # 5. Build Web App
      - name: Build Web App
        run: npm run build

      # === REQUIREMENT 1: XML PICK & AUTO GRADLE ===
      # Ye step tumhare XML ko bachata hai aur missing Gradle files banata hai
      - name: Smart Repair (Backup XML -> Fresh Gradle -> Restore XML)
        run: |
          echo "üîç Checking for existing XML..."
          
          # A. Agar tumhara XML hai, toh use safe jagah backup lo
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            echo "‚úÖ XML Found! Backing up..."
            cp android/app/src/main/AndroidManifest.xml manifest_backup.xml
            HAS_MANIFEST="true"
          else
            echo "‚ö†Ô∏è No XML found, creating fresh."
            HAS_MANIFEST="false"
          fi

          # B. Purana toota hua folder hatao (jisme gradle nahi tha)
          rm -rf android

          # C. Naya Android project banao (isme Gradle hoga)
          npx cap add android

          # D. Tumhara XML wapas restore karo
          if [ "$HAS_MANIFEST" = "true" ]; then
            echo "‚ôªÔ∏è Restoring your custom XML..."
            cp manifest_backup.xml android/app/src/main/AndroidManifest.xml
          fi

          # E. Sync karo taaki plugins set ho jayein
          npx cap sync android

      # === REQUIREMENT 2: ASSETS ICON PICK ===
      # Ye step tumhare assets/icon.png se Android icons banayega
      - name: Generate App Icons
        run: |
          npm install @capacitor/assets --save-dev
          npx capacitor-assets generate --android

      # === REQUIREMENT 3: ADMOB RUN (SAFETY CHECK) ===
      # Ye check karega ki tumhare XML me App ID hai ya nahi taaki ads chal sake
      - name: Ensure AdMob App ID exists
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          TEST_APP_ID="ca-app-pub-3940256099942544~3347511713"
          
          if grep -q "com.google.android.gms.ads.APPLICATION_ID" "$MANIFEST"; then
            echo "‚úÖ AdMob App ID tumhare XML mein pehle se hai."
          else
            echo "‚ö†Ô∏è App ID missing! Crash rokne ke liye Test ID daal raha hoon."
            sed -i "s|</application>|<meta-data android:name=\"com.google.android.gms.ads.APPLICATION_ID\" android:value=\"$TEST_APP_ID\"/>\n    </application>|" $MANIFEST
          fi

      # 8. Build APK (Ab Gradle Wrapper use hoga)
      - name: Build Debug APK
        working-directory: ./android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      # 9. Upload APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: final-app-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
