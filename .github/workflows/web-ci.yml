name: Web GPS Camera CI (No Android / No Gradle)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  web-build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Repo checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Node setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install deps (safe even if minimal)
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          else
            echo "No package.json, skipping npm install"
          fi

      # 4Ô∏è‚É£ Verify icon from assets
      - name: Verify app icon
        run: |
          if [ -f assets/icon.png ]; then
            echo "‚úÖ App icon found: assets/icon.png"
          else
            echo "‚ùå assets/icon.png missing"
            exit 1
          fi

      # 5Ô∏è‚É£ Verify Capacitor config (permissions layer)
      - name: Verify Capacitor permissions
        run: |
          if [ -f capacitor.config.json ]; then
            cat capacitor.config.json
            echo "‚úÖ Capacitor config present"
          else
            echo "‚ùå capacitor.config.json missing"
            exit 1
          fi

      # 6Ô∏è‚É£ Verify permission JS in index.html
      - name: Verify Camera & GPS permission logic
        run: |
          grep -q "getUserMedia" www/index.html && echo "‚úÖ Camera permission logic OK"
          grep -q "geolocation" www/index.html && echo "‚úÖ GPS permission logic OK"
          grep -q "Filesystem.requestPermissions" www/index.html && echo "‚úÖ Storage permission logic OK"

      # 7Ô∏è‚É£ Verify AdMob IDs
      - name: Verify AdMob configuration
        run: |
          grep -q "ca-app-pub-7807602925578307~7450691474" www/index.html && echo "‚úÖ AdMob App ID OK"
          grep -q "ca-app-pub-7807602925578307/5483003680" www/index.html && echo "‚úÖ Banner ID OK"
          grep -q "ca-app-pub-7807602925578307/8272818556" www/index.html && echo "‚úÖ Interstitial ID OK"

      # 8Ô∏è‚É£ Web-only build output (Android & Gradle bypass)
      - name: Web build (no Android, no Gradle)
        run: |
          echo "üö´ Android build skipped"
          echo "üö´ Gradle skipped"
          echo "‚úÖ Web content ready"
          ls -la www

      # 9Ô∏è‚É£ Upload web artifact
      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: gps-map-camera-web
          path: |
            www
            assets/icon.png
            capacitor.config.json
